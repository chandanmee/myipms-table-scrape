name: Distributed Web Scraping

on:
  workflow_dispatch:
    inputs:
      parallel_jobs:
        description: 'Number of parallel jobs'
        required: true
        default: '5'
        type: choice
        options:
          - '5'
          - '10'
          - '15'
      chunk_start:
        description: 'Start chunk number'
        required: true
        default: '1'
        type: string
      chunk_end:
        description: 'End chunk number'
        required: true
        default: '10'
        type: string

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          start=${{ inputs.chunk_start }}
          end=${{ inputs.chunk_end }}
          matrix="{\"chunk_num\":["
          for ((i=start; i<=end; i++)); do
            if [ $i -eq $start ]; then
              matrix+="$i"
            else
              matrix+=",$i"
            fi
          done
          matrix+="]}"
          echo "matrix=$matrix" >> $GITHUB_OUTPUT
          
  scrape-chunks:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
      max-parallel: ${{ inputs.parallel_jobs }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm install
      
    - name: Decode session cookies
      run: |
        mkdir -p data
        echo "${{ secrets.SESSION_DATA }}" | base64 --decode > session_cookies.json
        
    - name: Run scraping for chunk ${{ matrix.chunk_num }}
      run: node worker_script.js ${{ matrix.chunk_num }}
      
    - name: Upload scraped data
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/
        git commit -m "Add scraped data from chunk ${{ matrix.chunk_num }}" || echo "No changes to commit"
        git push
